#yaml
name: CI + Build and publish container
on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  ci:
    runs-on: ubuntu-latest
    outputs:
      commit: ${{ steps.meta.outputs.sha }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Restore
        run: dotnet restore

      - name: Build
        run: dotnet build --no-restore --configuration Release

      - name: Test
        run: dotnet test --no-build --verbosity normal

      - name: Publish app
        run: dotnet publish -c Release -o publish

      # yaml
      - name: Copy Dockerfile into publish
        run: |
          set -e
          DOCKERFILE=$(find . -maxdepth 4 -type f -name Dockerfile | head -n1 || true)
          if [ -z "$DOCKERFILE" ]; then
            echo "Dockerfile nicht gefunden. Lege `Dockerfile` in Repo-Root oder passe den Pfad im Workflow an." >&2
            exit 1
          fi
          cp "$DOCKERFILE" publish/
          echo "Copied $DOCKERFILE to publish/"
      
      
      - name: Upload published artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-publish
          path: publish

  image:
    needs: ci
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download published artifact
        uses: actions/download-artifact@v4
        with:
          name: app-publish
          path: publish
          
      - name: Set OWNER lowercase
        shell: bash
        run: |
          OWNER="${GITHUB_REPOSITORY_OWNER,,}"
          OWNER="${OWNER//\"/}"    # entferne doppelte Anführungszeichen, falls vorhanden
          OWNER="${OWNER//\'/}"    # entferne einfache Anführungszeichen, falls vorhanden
          echo "OWNER=$OWNER" >> $GITHUB_ENV


      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}


      - name: Build and push image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Biletado/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ghcr.io/${{ env.OWNER }}/biletado:${{ github.sha }}
            ghcr.io/${{ env.OWNER }}/biletado:latest
            
  deploy:
    needs: image
    runs-on: ubuntu-latest
    steps:
      - name: Kubernetes Context setzten
        uses: azure/k8s-set-context@v3
        with:
          method: kubeconfig
          kubeconfig: ${{ secrets.KUBE_CONFIG }}

      - name: Update Image in Deployment
        run: |
          kubectl rollout restart deployment/reservations